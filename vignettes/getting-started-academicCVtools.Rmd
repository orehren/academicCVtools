---
title: "Getting Started with academicCVtools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with academicCVtools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup_vignette, include=FALSE, eval=FALSE}
# This chunk is used for automated testing and setup, but not for rendering the vignette.
# For the actual vignette, we use mocked data.
library(mockery)

# Create a dummy Google Sheet for testing purposes
mocked_gs <- gs4_create("mocked_doc_id_for_vignette", sheets = c("work_experience", "education", "another_sheet"))
gs4_sheet_write(mocked_gs, data.frame(a = 1, b = 2), sheet = "work_experience")
gs4_sheet_write(mocked_gs, data.frame(x = "foo", y = "bar"), sheet = "education")

# Mock the googledrive::drive_get function to avoid actual API calls
stub(load_cv_sheets, "googledrive::drive_get", function(id) {
  if (id == "mocked_doc_id_for_vignette") {
    return(mocked_gs)
  } else {
    stop("Unexpected Google Sheet ID in vignette")
  }
})

# Mock the googlesheets4::read_sheet function
stub(load_cv_sheets, "googlesheets4::read_sheet", function(ss, sheet, ...) {
  if (sheet == "work_experience") {
    return(data.frame(
      Date = c("2022-Present", "2020-2022"),
      Title = c("Postdoctoral Researcher", "PhD Candidate"),
      Institution = c("University of Example", "University of Example"),
      Description = c("Doing research on stuff.", "Did research on other stuff.")
    ))
  } else if (sheet == "education") {
    return(data.frame(
      Degree = c("PhD in Psychology", "MSc in Psychology"),
      Institution = c("University of Example", "University of Example"),
      Year = c(2022, 2018)
    ))
  } else {
    stop("Unexpected sheet name in vignette")
  }
})
```

## Introduction

`academicCVtools` is an R package designed to help you create a data-driven academic CV. It provides functions to read your CV data from a Google Sheet and format it for use with Quarto and Typst.

## Installation

You can install the development version of `academicCVtools` from GitHub with:

```{r installation, eval=FALSE}
# install.packages("devtools")
devtools::install_github("orehren/academicCVtools")
```

## Usage

First, load the package:

```{r load_package}
library(academicCVtools)
```

### Authentication

When you first use a function that accesses Google Drive or Google Sheets, you will be prompted to authenticate with your Google account. This is a one-time process.

```{r auth_conceptual, eval=FALSE}
# This will trigger the authentication process
# (the first time you run it)
googledrive::drive_find(n_max = 5)
```

### Example Data

For this example, we'll use a mocked Google Sheet with the following data:

**Sheet: `work_experience`**

| Date | Title | Institution | Description |
|---|---|---|---|
| 2022-Present | Postdoctoral Researcher | University of Example | Doing research on stuff. |
| 2020-2022 | PhD Candidate | University of Example | Did research on other stuff. |

**Sheet: `education`**

| Degree | Institution | Year |
|---|---|---|
| PhD in Psychology | University of Example | 2022 |
| MSc in Psychology | University of Example | 2018 |

```{r example_data_setup, include=FALSE}
# This is where we would normally load the data from the Google Sheet
# For this vignette, we'll create the data frames manually
work_experience <- data.frame(
  Date = c("2022-Present", "2020-2022"),
  Title = c("Postdoctoral Researcher", "PhD Candidate"),
  Institution = c("University of Example", "University of Example"),
  Description = c("Doing research on stuff.", "Did research on other stuff.")
)

education <- data.frame(
  Degree = c("PhD in Psychology", "MSc in Psychology"),
  Institution = c("University of Example", "University of Example"),
  Year = c(2022, 2018)
)
```

### Publications

You can also include a list of publications from a `.bib` file.

```{r example_pubs_setup, include=FALSE}
bib_content <- c(
  "@article{Author2023, author={Jane Doe}, title={A great paper}, year={2023}}",
  "@inproceedings{Author2022, author={Jane Doe}, title={A conference talk}, year={2022}}"
)
bib_file <- tempfile(fileext = ".bib")
writeLines(bib_content, bib_file)

csl_content <- '<?xml version="1.0" encoding="utf-8"?>
<style xmlns="http://purl.org/net/xbiblio/csl" class="in-text" version="1.0">
  <info><title>Simple CSL</title><id>simple-csl</id></info>
  <bibliography><layout><text variable="title"/></layout></bibliography>
</style>'
csl_file <- tempfile(fileext = ".csl")
writeLines(csl_content, csl_file)
```

### Formatting CV Sections

The `format_typst_section` function takes a data frame and formats it into a series of Typst function calls.

```{r format_work_experience}
format_typst_section(
  work_experience,
  typst_func = "#cvEntry"
)
```

## Example Quarto Document

Here is an example of how you might use these functions in a Quarto document to generate a complete CV.

```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Work Experience

```{r work_experience_qmd, results='asis'}
cat("```quarto\n")
cat(format_typst_section(
  work_experience,
  typst_func = "#cvEntry"
))
cat("\n```")
```

### Education

```{r education_qmd, results='asis'}
cat("```quarto\n")
cat(format_typst_section(
  education,
  typst_func = "#cvEntry"
))
cat("\n```")
```

### Publications

```{r publications_qmd, results='asis'}
cat("```quarto\n")
cat(create_publication_list(
  bib_file = bib_file,
  author_name = "Jane Doe",
  csl_file = csl_file
))
cat("\n```")
```
